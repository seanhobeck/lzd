#!/usr/bin/env bash
set -euo pipefail

# must be run as root (or via sudo)
if [[ $EUID -ne 0 ]]; then
  echo "get-deps failed; please run as root (or with su)."
  exit 1
fi
ARCH="$(uname -m)"
OS_ID=""
OS_LIKE=""
if [[ -f /etc/os-release ]]; then
  . /etc/os-release
  OS_ID="${ID:-}"
  OS_LIKE="${ID_LIKE:-}"
else
  echo "get-deps failed; cannot determine linux distribution."
  exit 1
fi
echo "detected arch: $ARCH."
echo "detected os: $OS_ID."

# sanity check arch
case "$ARCH" in
  x86_64|aarch64|armv7l|riscv64)
    ;;
  *)
    echo "get-deps failed; unsupported arch: $ARCH."
    exit 1
    ;;
esac

# for apt pm distros.
install_apt() {
  apt-get update
  apt-get install -y \
    gcc \
    build-essential \
    binutils \
    clang \
    clang-tools \
    flawfinder \
    valgrind \
    cmake \
    ninja-build

  # qemu + cross-compilers.
  apt-get install \
    qemu-user \
    qemu-user-static \
    binfmt-support \
    gcc-aarch64-linux-gnu \
    gcc-arm-linux-gnueabihf \
    gcc-i686-linux-gnu
}

# for dnf pm distros.
install_dnf() {
  dnf install -y \
    gcc \
    gcc-c++ \
    make \
    binutils \
    clang \
    clang-tools-extra \
    flawfinder \
    valgrind \
    cmake \
    ninja-build

  # qemu + cross-compilers
  dnf install \
    qemu-user \
    qemu-system-x86 \
    qemu-system-arm \
    gcc-aarch64-linux-gnu \
    gcc-arm-linux-gnu
}

# for pacman pm distros.
install_pacman() {
  pacman -Sy --noconfirm \
    gcc \
    binutils \
    clang \
    flawfinder \
    valgrind \
    cmake \
    ninja-build

  # qemu + cross-compilers
  pacman -Sy --noconfirm \
    qemu \
    aarch64-linux-gnu-gcc \
    arm-linux-gnueabihf-gcc
}

# for zypper pm distros.
install_zypper() {
  zypper refresh
  zypper install -y \
    gcc \
    gcc-c++ \
    make \
    binutils \
    clang \
    clang-tools \
    flawfinder \
    clang-tidy \
    valgrind \
    cmake \
    ninja-build

  # qemu + cross-compilers
  zypper install \
    qemu \
    qemu-tools \
    qemu-extra \
    cross-aarch64-gcc12 \
    cross-arm-gcc12
}

# go through each dist.
case "$OS_ID" in
  ubuntu|debian|linuxmint)
    install_apt
    ;;
  fedora|rhel|centos|rocky|almalinux)
    install_dnf
    ;;
  arch)
    install_pacman
    ;;
  opensuse*|sles)
    install_zypper
    ;;
  alpine)
    install_apk
    ;;
  *)
    # fallback using ID_LIKE
    case "$OS_LIKE" in
      *debian*)
        install_apt
        ;;
      *rhel*|*fedora*)
        install_dnf
        ;;
      *)
        echo "get-deps; unsupported dist.: $OS_ID."
        exit 1
        ;;
    esac
    ;;
esac
echo "get-deps, all dependencies installed successfully!"

# start compiling capstone and other vendor deps.
echo "starting compilation of vendor submodules."
git submodule update --init --recursive

# build each architecture specified with (arch, cc).
build_per_arch() {
  local arch="$1"
  local cc="$2"
  local build_dir="vendor/build/$arch"

  # remake the dir.
  rm -rf "$build_dir"
  mkdir -p "$build_dir"

  # compile using cmake.
  "cmake" -S "vendor/capstone" -B "$build_dir" -G "Ninja" \
    -DCMAKE_BUILD_TYPE=Release \
    -DCMAKE_SYSTEM_NAME=Linux \
    -DCMAKE_C_COMPILER="$cc" \
    -DCMAKE_INSTALL_PREFIX="$build_dir" \
    -DCAPSTONE_BUILD_SHARED=ON \
    -DCAPSTONE_BUILD_STATIC=ON

  "cmake" --build "$build_dir"
  "cmake" --install "$build_dir"
  # should specify where but we are going to keep this local to the repository.
}

# per architecture.
build_per_arch x86_64 gcc
build_per_arch x86 i686-linux-gnu-gcc
build_per_arch arm32 arm-linux-gnueabihf-gcc
build_per_arch aarch64 aarch64-linux-gnu-gcc
echo "get-deps, vendor submodules compiled, we are done!"